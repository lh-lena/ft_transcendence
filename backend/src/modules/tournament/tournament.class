import { v4 as uuidv4 } from 'uuid';
import type {
  tournamentType,
  tournamentCreateType,
  tournamentResponseType,
} from '../../schemas/tournament';

import { userType } from '../../schemas/user';
import { userController } from '../user/user.controller';

import { NotFoundError } from '../../utils/error';

export class tournamentClass {

  private activeTournaments: tournamentType[] = [];

  constructor() {
    this.activeTournaments = [
      {
        tournamentId: uuidv4(),
        playerAmount: 4,
        players: [],
        status: 'waiting',
        games: []
      },
      {
        tournamentId: uuidv4(),
        playerAmount: 8,
        players: [],
        status: 'waiting',
        games: []
      },
      {
        tournamentId: uuidv4(),
        playerAmount: 16,
        players: [],
        status: 'waiting',
        games: []
      },
      {
        tournamentId: uuidv4(),
        playerAmount: 32,
        players: [],
        status: 'waiting',
        games: []
      }
    ];
  }

  private async matchPlayerToTournament(user: userType, playerAmount: number) {
    const tournament = this.activeTournaments.find((t) => t.status === 'waiting' && t.playerAmount === playerAmount);

    if (!tournament) throw new NotFoundError('No available tournament found');
    tournament.players.push(user);
    if (tournament.players.length === tournament.playerAmount) {
      await this.startTournament(tournament);
    }
    return tournament;
  }
}

  async startTournament(tournament: tournamentType) {
  tournament.status = 'ready';
  this.activeTournaments.push(
    {
      tournamentId: uuidv4(),
      playerAmount: tournament.playerAmount,
      players: [],
      status: 'waiting',
      games: []
    }
  }


        async join(data: tournamentCreateType): Promise < tournamentType > {
  const user = await userController.getById(data.userId);
  if(!user) throw new NotFoundError('User not found');

  let tournament = this.activeTournaments.find((t) => t.players.some((p) => p.id === user.id));

  if(tournament) return tournament;

  tournament = this.matchPlayerToTournament(user);

  return tournament;
};

}
