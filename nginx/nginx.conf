events {}

http {
  limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
  server {
    listen 443 ssl;
    server_name localhost;

    #SSL certificate configuration
    ssl_certificate     /etc/nginx/ssl/selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/selfsigned.key;

    #SSL protocols and ciphers
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    #SSL headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
    
    location / {
      proxy_pass http://frontend:3000;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
      proxy_pass http://backend:8080/api/; 
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ws/ {
      proxy_pass http://realtime:8081/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "Upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location /auth/ {
      proxy_pass http://auth-service:8082/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /nginx_status {
      stub_status on;
      access_log off;
      allow 10.0.0.0/8;      # 10.0.0.0 - 10.255.255.255
      allow 172.16.0.0/12;   # 172.16.0.0 - 172.31.255.255
      allow 192.168.0.0/16;  # 192.168.0.0 - 192.168.255.255
      allow 127.0.0.1;       # localhost
      allow ::1;             # IPv6 localhost
      deny all;
    }
    location /prometheus/ {
        proxy_pass http://prometheus:9090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /grafana/ {
        proxy_pass http://grafana:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
  
  server {
    listen 80;
    server_name localhost;
    
    # Allow nginx_status on HTTP for monitoring
    location /nginx_status {
      stub_status on;
      access_log off;
      allow 10.0.0.0/8;      # 10.0.0.0 - 10.255.255.255
      allow 172.16.0.0/12;   # 172.16.0.0 - 172.31.255.255
      allow 192.168.0.0/16;  # 192.168.0.0 - 192.168.255.255
      allow 127.0.0.1;       # localhost
      allow ::1;             # IPv6 localhost
      deny all;
    }
    
    # Redirect all other traffic to HTTPS
    location / {
      return 301 https://$server_name$request_uri;
    }
  }
}