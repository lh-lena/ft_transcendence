name: CI/CD Pipeline

on:
  push:
    branches: ['**']
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  #1: Linting and formatting
  lint-format:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [frontend, backend, realtime, auth-service]
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ matrix.service }}/node_modules
          key: ${{ runner.os }}-${{ matrix.service }}-${{ hashFiles(format('{0}/package-lock.json', matrix.service)) }}
      
      - name: Install dependencies
        working-directory: ${{ matrix.service }}
        run: |
          if [ ! -f package.json ]; then
            echo '{"name": "${{ matrix.service }}", "scripts": {"lint": "echo lint", "format:check": "echo format"}}' > package.json
          fi
          npm install
      
      - name: Run ESLint
        working-directory: ${{ matrix.service }}
        run: npm run lint || echo "Linting not configured yet"
      
      - name: Check Prettier formatting
        working-directory: ${{ matrix.service }}
        run: npm run format:check || echo "Formatting not configured yet"

  #2: Build Verification
  build-verify:
    runs-on: ubuntu-latest
    needs: lint-format
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Create SSL certificates for nginx
        run: |
          mkdir -p nginx/ssl
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout nginx/ssl/selfsigned.key \
            -out nginx/ssl/selfsigned.crt \
            -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"
          
          # Verify certificates were created
          ls -la nginx/ssl/
          echo "SSL certificates created successfully"     
      - name: Create CI override file
        run: |
          cat > docker-compose.ci.yml << 'EOF'
          version: '3.8'
          
          services:
            nginx:
              depends_on:
                backend:
                  condition: service_healthy
                frontend:
                  condition: service_healthy
                realtime:
                  condition: service_started
                auth-service:
                  condition: service_started
            
            frontend:
              healthcheck:
                test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
                interval: 5s
                timeout: 5s
                retries: 20
                start_period: 40s
            
            backend:
              healthcheck:
                test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/health"]
                interval: 5s
                timeout: 5s
                retries: 20
                start_period: 30s
            
            # Disable monitoring services
            prometheus:
              profiles:
                - monitoring
            grafana:
              profiles:
                - monitoring
            nginx-exporter:
              profiles:
                - monitoring
          EOF
      
      - name: Build all services (excluding monitoring)
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.ci.yml build
      
      - name: Verify single command startup
        run: |
          # Start all services except nginx first
          docker-compose -f docker-compose.yml -f docker-compose.ci.yml up -d backend frontend realtime auth-service
          sleep 15  # Wait for services to start
          # Now start nginx after other services are ready
          docker-compose -f docker-compose.yml -f docker-compose.ci.yml up -d nginx
          
          echo "Waiting for containers to initialize..."
          sleep 20
          
          echo "=== Container Status ==="
          docker-compose ps
          
          # Wait for frontend with better error handling
          echo "Waiting for frontend to be ready..."
          for i in {1..60}; do
            if docker-compose exec -T frontend wget --quiet --tries=1 --spider http://localhost:3000; then
              echo "Frontend is ready!"
              break
            fi
            echo "Attempt $i/60: Frontend not ready yet..."
            if [ $i -eq 30 ]; then
              echo "=== Frontend logs at 30 seconds ==="
              docker logs ft_transcendence_frontend --tail=20 || true
            fi
            sleep 2
          done
          
          # Check backend
          echo "Checking backend..."
          for i in {1..30}; do
            if curl -f http://localhost:8080/api/health 2>/dev/null; then
              echo "Backend is ready!"
              break
            fi
            sleep 2
          done
          
          # Check auth service
          echo "Checking auth service..."
          for i in {1..30}; do
            if curl -f http://localhost:8082/api/auth/health 2>/dev/null; then
              echo "Auth service is ready!"
              break
            fi
            sleep 2
          done
          
      - name: Health checks
        run: |
          # Frontend through nginx (the actual issue)
          for i in {1..10}; do
            if curl -f http://localhost 2>/dev/null; then
              echo "Nginx -> Frontend proxy working!"
              break
            fi
            echo "Attempt $i/10: Nginx proxy not ready..."
            sleep 3
          done
          
          # Final verification
          curl -f http://localhost || {
            echo "=== Nginx Error - Debugging ==="
            docker logs ft_transcendence_nginx --tail=20
            echo "=== Frontend Status ==="
            docker logs ft_transcendence_frontend --tail=20
            exit 1
          }
          
          # Backend
          curl -f http://localhost:8080/api/health || echo "Backend health check endpoint needed"
          
          # Auth
          curl -f http://localhost:8082/api/auth/health || echo "Auth health check endpoint needed"
          
      - name: Check HTTPS/WSS configuration
        run: |
          # Verify nginx SSL config
          docker-compose exec -T nginx nginx -t
          # Check if HTTPS redirect works
          curl -I http://localhost | grep "301 Moved Permanently" || true
          
      - name: Stop services
        if: always()
        run: docker-compose -f docker-compose.yml -f docker-compose.ci.yml down

  #3: Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    needs: lint-format
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
      
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  #4: TypeScript Compilation Check
  typescript-check:
    runs-on: ubuntu-latest
    needs: lint-format
    strategy:
      matrix:
        service: [frontend, backend, realtime, auth-service]
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install TypeScript
        working-directory: ${{ matrix.service }}
        run: |
          npm install --save-dev typescript @types/node
          
      - name: Compile TypeScript
        working-directory: ${{ matrix.service }}
        run: |
          npx tsc --noEmit || echo "TypeScript not configured yet"

  integration-test:
    runs-on: ubuntu-latest
    needs: [build-verify, security-scan, typescript-check]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
      
      - name: Create SSL certificates for CI
        run: |
          mkdir -p nginx/ssl
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout nginx/ssl/selfsigned.key \
            -out nginx/ssl/selfsigned.crt \
            -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"
      
      - name: Create CI override file
        run: |
          cat > docker-compose.ci.yml << 'EOF'
          version: '3.8'
          
          services:
            # Disable monitoring services only
            prometheus:
              profiles:
                - monitoring
            grafana:
              profiles:
                - monitoring
            nginx-exporter:
              profiles:
                - monitoring
          EOF
      
      - name: Make wait-for-it.sh executable
        run: chmod +x ./scripts/wait-for-it.sh || true
      
      - name: Start services with docker-compose
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.ci.yml up -d
          
          # Give extra time for proper initialization
          echo "Waiting for all services to stabilize..."
          sleep 30
          
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          
          # Direct service checks first
          for i in {1..60}; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "Frontend is accessible!"
              break
            fi
            sleep 2
          done
          
          for i in {1..60}; do
            if curl -f http://localhost:8080/api/health 2>/dev/null; then
              echo "Backend is accessible!"
              break
            fi
            sleep 2
          done
          
          # Now check nginx proxy
          for i in {1..30}; do
            if curl -f http://localhost 2>/dev/null; then
              echo "Nginx proxy is working!"
              break
            fi
            sleep 2
          done
          
          # Check if all containers are running
          docker-compose ps
          
      - name: Run integration tests through nginx
        run: |
          # Test frontend serves through nginx
          curl -f https://localhost --insecure -v || { 
            echo "Frontend test failed. Checking nginx logs..."
            docker-compose logs nginx --tail=30
            exit 1
          }
          
          # Test API endpoints through nginx
          curl -f https://localhost/api/health --insecure -v || {
            echo "API test failed. Checking backend logs..."
            docker-compose logs backend --tail=30
            docker-compose logs nginx --tail=30
            exit 1
          }
          
          # Test Auth endpoints through nginx
          curl -f https://localhost/auth/api/auth/health --insecure -v || {
            echo "Auth test failed. Checking auth-service logs..."
            docker-compose logs auth-service --tail=30
            docker-compose logs nginx --tail=30
            exit 1
          }
          
      - name: Debug information on failure
        if: failure()
        run: |
          echo "=== Docker Compose Status ==="
          docker-compose ps
          echo "=== Nginx Logs ==="
          docker-compose logs nginx --tail=30
          echo "=== Backend Logs ==="
          docker-compose logs backend --tail=30
          echo "=== Frontend Logs ==="
          docker-compose logs frontend --tail=30
          echo "=== Auth Service Logs ==="
          docker-compose logs auth-service --tail=30
          
      - name: Cleanup
        if: always()
        run: docker-compose -f docker-compose.yml -f docker-compose.ci.yml down -v

  deploy:
    runs-on: ubuntu-latest
    needs: [lint-format, build-verify, security-scan, typescript-check]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: 99185fd8-e3be-4313-91ef-5055524820af
        run: |
          # Link to your specific project
          railway link 99185fd8-e3be-4313-91ef-5055524820af
          
          # Deploy the entire docker-compose setup
          railway up --detach
          
      - name: Verify Deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway status
          echo "Deployment completed successfully!"