name: CI/CD Pipeline

on:
  push:
    branches: ['**']
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  #1: Linting and formatting
  lint-format:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [frontend, backend, realtime, auth-service]
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ matrix.service }}/node_modules
          key: ${{ runner.os }}-${{ matrix.service }}-${{ hashFiles(format('{0}/package-lock.json', matrix.service)) }}
      
      - name: Install dependencies
        working-directory: ${{ matrix.service }}
        run: |
          if [ ! -f package.json ]; then
            echo '{"name": "${{ matrix.service }}", "scripts": {"lint": "echo lint", "format:check": "echo format"}}' > package.json
          fi
          npm install
      
      - name: Run ESLint
        working-directory: ${{ matrix.service }}
        run: npm run lint || echo "Linting not configured yet"
      
      - name: Check Prettier formatting
        working-directory: ${{ matrix.service }}
        run: npm run format:check || echo "Formatting not configured yet"

  #2: Build Verification
  build-verify:
    runs-on: ubuntu-latest
    needs: lint-format
    steps:
      - uses: actions/checkout@v3
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
      
      - name: Build all services
        run: docker-compose build
      
      - name: Verify single command startup
        run: |
          docker-compose up -d
          echo "Waiting for containers to initialize..."
          sleep 20  # Give more time
          
          echo "=== Container Status ==="
          docker-compose ps
          
          echo "=== Frontend Container Logs ==="
          docker logs ft_transcendence_frontend || true
          
          # Try different approaches to check frontend
          echo "=== Checking frontend connectivity ==="
          
          # First check if container is running
          if docker ps | grep -q ft_transcendence_frontend; then
            echo "Frontend container is running"
            
            # Check what's listening inside the container
            docker exec ft_transcendence_frontend sh -c "netstat -tuln 2>/dev/null || ss -tuln 2>/dev/null || echo 'No netstat/ss available'" || true
            
            # Try to curl from inside the container
            docker exec ft_transcendence_frontend sh -c "curl -f http://localhost:3000 || wget -O- http://localhost:3000" || true
          else
            echo "Frontend container is not running!"
            exit 1
          fi
          
          # Extended wait with more attempts
          echo "Waiting for frontend to be ready..."
          for i in {1..60}; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "Frontend is ready!"
              break
            fi
            echo "Attempt $i/60: Frontend not ready yet..."
            if [ $i -eq 30 ]; then
              echo "=== Frontend logs at 30 seconds ==="
              docker logs ft_transcendence_frontend || true
            fi
            sleep 2
          done
          
          # Final check
          curl -f http://localhost:3000 || {
            echo "=== FINAL Frontend logs ==="
            docker logs --tail=50 ft_transcendence_frontend
            exit 1
          }
          
          # Continue with other checks...
          for i in {1..30}; do
            curl -f http://localhost:8080/api/health && break || sleep 2
          done
          
          for i in {1..30}; do
            curl -f http://localhost:8082/api/auth/health && break || sleep 2
          done
      - name: Health checks
        run: |
          # Frontend
          curl -f http://localhost:3000 || exit 1
          # Backend
          curl -f http://localhost:8080/api/health || echo "Backend health check endpoint needed"
          # Auth
          curl -f http://localhost:8082/api/auth/health || echo "Auth health check endpoint needed"
          # WebSocket test would go here
          
      - name: Check HTTPS/WSS configuration
        run: |
          # Verify nginx SSL config
          docker-compose exec -T nginx nginx -t
          # Check if HTTPS redirect works
          curl -I http://localhost | grep "301 Moved Permanently"
          
      - name: Stop services
        if: always()
        run: docker-compose down

  #3: Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    needs: lint-format
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
      
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  #4: TypeScript Compilation Check
  typescript-check:
    runs-on: ubuntu-latest
    needs: lint-format
    strategy:
      matrix:
        service: [frontend, backend, realtime, auth-service]
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install TypeScript
        working-directory: ${{ matrix.service }}
        run: |
          npm install --save-dev typescript @types/node
          
      - name: Compile TypeScript
        working-directory: ${{ matrix.service }}
        run: |
          npx tsc --noEmit || echo "TypeScript not configured yet"

  integration-test:
    runs-on: ubuntu-latest
    needs: [build-verify, security-scan, typescript-check]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
      
      - name: Create SSL certificates for CI
        run: |
          mkdir -p nginx/ssl
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout nginx/ssl/selfsigned.key \
            -out nginx/ssl/selfsigned.crt \
            -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"
      
      - name: Make wait-for-it.sh executable
        run: chmod +x ./scripts/wait-for-it.sh
      
      - name: Start services with docker-compose
        run: |
          docker-compose up -d
          
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          
          # Wait for backend
          ./scripts/wait-for-it.sh localhost:8080 -t 120
          
          # Wait for frontend with health check verification
          echo "Waiting for frontend to be healthy..."
          for i in {1..60}; do
            if docker inspect --format='{{.State.Health.Status}}' ft_transcendence_frontend | grep -q "healthy"; then
              echo "Frontend is healthy!"
              break
            fi
            echo "Attempt $i/60: Frontend health status: $(docker inspect --format='{{.State.Health.Status}}' ft_transcendence_frontend)"
            if [ $i -eq 30 ]; then
              echo "=== Frontend logs at 30 seconds ==="
              docker logs ft_transcendence_frontend
            fi
            sleep 2
          done
          
          # Verify frontend is truly ready
          curl -f http://localhost:3000 || {
            echo "Frontend health check passed but service not responding"
            docker logs ft_transcendence_frontend
            exit 1
          }
          
          # Wait for other services
          ./scripts/wait-for-it.sh localhost:8082 -t 120
          ./scripts/wait-for-it.sh localhost:443 -t 120
      - name: Debug frontend status
        run: |
          echo "=== Check if frontend is actually listening ==="
          docker exec ft_transcendence_frontend sh -c "netstat -tuln | grep 3000 || ss -tuln | grep 3000" || echo "Port 3000 not listening"
          
          echo "=== Frontend container logs ==="
          docker logs ft_transcendence_frontend --tail=50
          
          echo "=== Test frontend directly (bypass nginx) ==="
          curl -f http://localhost:3000 || echo "Frontend not responding on 3000"
          
          echo "=== Check container health ==="
          docker ps | grep frontend          
      - name: Check service health
        run: |
          # Check if services are responding directly
          curl -f http://localhost:3000 || echo "Frontend direct access check"
          curl -f http://localhost:8080/api/health || echo "Backend direct access check"
          curl -f http://localhost:8082/api/auth/health || echo "Auth direct access check"
          
      - name: Run integration tests through nginx
        run: |
          # Test frontend serves through nginx
          curl -f https://localhost --insecure -v || { 
            echo "Frontend test failed. Checking nginx logs..."
            docker-compose logs nginx
            exit 1
          }
          
          # Test API endpoints through nginx
          curl -f https://localhost/api/health --insecure -v || {
            echo "API test failed. Checking backend logs..."
            docker-compose logs backend
            docker-compose logs nginx
            exit 1
          }
          
          # Test Auth endpoints through nginx
          curl -f https://localhost/auth/api/auth/health --insecure -v || {
            echo "Auth test failed. Checking auth-service logs..."
            docker-compose logs auth-service
            docker-compose logs nginx
            exit 1
          }
          
          # Test WebSocket upgrade
          curl -f https://localhost/ws/ --insecure -H "Upgrade: websocket" -H "Connection: Upgrade" -v || echo "WebSocket test (expected to fail without full handshake)"
          
      - name: Debug information on failure
        if: failure()
        run: |
          echo "=== Docker Compose Status ==="
          docker-compose ps
          echo "=== Nginx Logs ==="
          docker-compose logs nginx
          echo "=== Backend Logs ==="
          docker-compose logs backend
          echo "=== Frontend Logs ==="
          docker-compose logs frontend
          echo "=== Auth Service Logs ==="
          docker-compose logs auth-service
          echo "=== Network Information ==="
          docker network ls
          docker network inspect $(docker-compose ps -q nginx) || true
          
      - name: Cleanup
        if: always()
        run: docker-compose down -v

  deploy:
    runs-on: ubuntu-latest
    needs: [lint-format, build-verify, security-scan, typescript-check]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: 99185fd8-e3be-4313-91ef-5055524820af
        run: |
          # Link to your specific project
          railway link 99185fd8-e3be-4313-91ef-5055524820af
          
          # Deploy the entire docker-compose setup
          railway up --detach
          
      - name: Verify Deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway status
          echo "Deployment completed successfully!"